version: '2'

vars:
  DIRECTORIES:
    sh: find . -type f -name '*.tf' -not -path "**/.terraform/*" -exec dirname {} \; | sort -u
  FILES:
    sh: find . -type f -name '*.tf' -not -path "**/.terraform/*"

tasks:
  default:
    cmds:
    - task: test

  tidy:
    desc: Tidy all the things.
    silent: true
    cmds:
    - go mod tidy
    - |
      for f in $(echo "{{.FILES}}"); do 
        sed -i '' -E "s/^([ ]*required_version[ ]*=[ ]*)\"([^\"]*)\"/\\1\"{{.TERRAFORM_VERSION}}\"/g" $f
      done
    vars:
      TERRAFORM_VERSION: '>= 0.12'

  test:
    desc: Run tests for all terraform directories.
    silent: true
    cmds:
    - |
      BOLD=$(tput bold)
      NORM=$(tput sgr0)

      for d in $(echo "{{.DIRECTORIES}}"); do 
        echo "${BOLD} $d:${NORM}"
        cd $d

        if ! terraform fmt -check=true -write=true -list=false -recursive=false; then
          echo "  ✗ terraform fmt" && exit $?
        else
          echo "  √ terraform fmt"
        fi

        if ! terraform init -backend=false -input=false -get=true -get-plugins=true -no-color > /dev/null; then
          echo "  ✗ terraform init" && exit $?
        else
          echo "  √ terraform init"
        fi

        if ! terraform validate > /dev/null; then
          echo "  ✗ terraform validate" && exit $?
        else
          echo "  √ terraform validate"
        fi
      done

  e2e:
    desc: Run the end 2 end test suite.
    cmds:
    - go test -v ./... -timeout=1h
    